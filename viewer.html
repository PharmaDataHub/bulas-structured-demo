<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR ePI Viewer | HL7 Package Leaflet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        accent: { 500: '#10b981', 600: '#059669' },
                    }
                }
            }
        }
    </script>
    <style>
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .section.active .section-content {
            max-height: 10000px;
        }

        .section.active .toggle-icon {
            transform: rotate(180deg);
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .gradient-border {
            background: linear-gradient(90deg, #3b82f6, #10b981);
        }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .rendered-content ul {
            list-style: none;
            padding-left: 0;
        }

        .rendered-content ul li {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .rendered-content ul li::before {
            content: '';
            width: 0.5rem;
            height: 0.5rem;
            background-color: #3b82f6;
            border-radius: 50%;
            margin-top: 0.5rem;
            flex-shrink: 0;
        }

        .rendered-content ol {
            list-style: decimal;
            padding-left: 1.5rem;
        }

        .rendered-content ol li {
            margin-bottom: 0.25rem;
        }

        .rendered-content p {
            margin-bottom: 0.75rem;
        }

        .rendered-content strong {
            color: #1e293b;
        }

        .rendered-content a {
            color: #2563eb;
            text-decoration: underline;
        }

        .rendered-content a:hover {
            color: #1d4ed8;
        }

        /* Special content boxes */
        .warning-box {
            background: linear-gradient(to right, #fef2f2, #fef2f2);
            border-left: 4px solid #ef4444;
            border-radius: 0 0.75rem 0.75rem 0;
            padding: 1rem;
            margin: 1rem 0;
        }

        .warning-box-title {
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .warning-box-content {
            color: #b91c1c;
        }

        .info-box {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .info-box-title {
            font-weight: 600;
            color: #075985;
            margin-bottom: 0.5rem;
        }

        .info-box-content {
            color: #0369a1;
        }

        .dosage-box {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .dosage-box.purple {
            background-color: #faf5ff;
            border-color: #e9d5ff;
        }

        .dosage-box-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dosage-box.purple .dosage-box-title {
            color: #6b21a8;
        }

        .dosage-box-content {
            color: #1d4ed8;
        }

        .dosage-box.purple .dosage-box-content {
            color: #7c3aed;
        }

        /* Side effects frequency styling */
        .frequency-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .frequency-item.very-common {
            background: linear-gradient(to right, #fee2e2, #fef2f2);
        }

        .frequency-item.common {
            background: linear-gradient(to right, #ffedd5, #fff7ed);
        }

        .frequency-item.uncommon {
            background: linear-gradient(to right, #fef9c3, #fefce8);
        }

        .frequency-item.rare {
            background: linear-gradient(to right, #dbeafe, #eff6ff);
        }

        .frequency-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            margin-top: 0.375rem;
            flex-shrink: 0;
        }

        .frequency-dot.very-common {
            background-color: #ef4444;
        }

        .frequency-dot.common {
            background-color: #f97316;
        }

        .frequency-dot.uncommon {
            background-color: #eab308;
        }

        .frequency-dot.rare {
            background-color: #3b82f6;
        }

        .frequency-label {
            font-weight: 700;
        }

        .frequency-label.very-common {
            color: #b91c1c;
        }

        .frequency-label.common {
            color: #c2410c;
        }

        .frequency-label.uncommon {
            color: #a16207;
        }

        .frequency-label.rare {
            color: #1d4ed8;
        }

        /* Frequency legend */
        .frequency-legend {
            display: grid;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .frequency-legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
        }

        /* Storage grid */
        .storage-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            margin: 1rem 0;
        }

        .storage-item {
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .storage-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Subsection label */
        .subsection-label {
            display: inline-block;
            background-color: #f1f5f9;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.5rem;
        }

        /* Nested sections styling */
        .nested-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .nested-section-title {
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.5rem;
            display: inline-block;
            background-color: #f1f5f9;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen font-sans text-slate-800">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-6xl mx-auto px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <i class="fas fa-pills text-2xl text-blue-200"></i>
                <span class="font-semibold text-lg">FHIR ePI Viewer</span>
            </div>
            <p class="text-sm text-blue-100 text-center md:text-left flex-1 max-w-xl hidden md:block">
                Visualizador de Folhetos Informativos HL7 FHIR — Carregue qualquer Bundle ePI
            </p>
            <button onclick="showUploadSection()" id="newDocBtn"
                class="hidden items-center gap-2 px-5 py-2.5 bg-white/10 hover:bg-white/20 border border-white/20 rounded-xl text-sm font-medium transition-all hover:-translate-y-0.5">
                <i class="fas fa-upload"></i> Novo Documento
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-10">
        <!-- Upload Section -->
        <div id="uploadSection" class="bg-white rounded-3xl shadow-xl p-8 md:p-12 mb-8 relative overflow-hidden">
            <div class="gradient-border h-1.5 absolute top-0 left-0 right-0 rounded-t-3xl"></div>
            <div class="text-center mb-8">
                <span
                    class="inline-flex items-center gap-2 bg-blue-50 text-blue-600 px-4 py-2 rounded-full text-xs font-semibold uppercase tracking-wider mb-6">
                    <i class="fas fa-file-medical"></i> HL7 FHIR
                </span>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">Visualizador de ePI</h1>
                <p class="text-slate-500 max-w-md mx-auto">Carregue um ficheiro FHIR Bundle (JSON) ou introduza um URL
                    para visualizar o folheto informativo</p>
            </div>

            <!-- File Drop Zone -->
            <div id="dropZone" class="drop-zone rounded-2xl p-8 text-center cursor-pointer mb-6"
                onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileSelect(event)">
                <div class="mb-4">
                    <i class="fas fa-cloud-upload-alt text-5xl text-slate-300"></i>
                </div>
                <p class="text-slate-600 font-medium mb-2">Arraste um ficheiro JSON aqui</p>
                <p class="text-slate-400 text-sm">ou clique para selecionar</p>
            </div>

            <!-- URL Input -->
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="urlInput" placeholder="Ou introduza o URL do ficheiro JSON..."
                    class="flex-1 px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button onclick="loadFromUrl()"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> Carregar
                </button>
            </div>

            <!-- Sample File Button -->
            <div class="mt-6 text-center">
                <button onclick="loadSampleFile()"
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium underline">
                    <i class="fas fa-flask mr-1"></i> Carregar ficheiro de exemplo
                </button>
            </div>

            <!-- Error Message -->
            <div id="errorMessage"
                class="hidden mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="errorText"></span>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden flex justify-center items-center py-12">
            <div class="spinner"></div>
            <span class="ml-3 text-slate-500">A carregar documento...</span>
        </div>

        <!-- Document Content (rendered dynamically) -->
        <div id="documentContent" class="hidden">
            <!-- Hero Card - populated dynamically -->
            <div id="heroCard" class="bg-white rounded-3xl shadow-xl p-8 md:p-12 mb-8 relative overflow-hidden">
                <div class="gradient-border h-1.5 absolute top-0 left-0 right-0 rounded-t-3xl"></div>
                <div class="text-center">
                    <span
                        class="inline-flex items-center gap-2 bg-blue-50 text-blue-600 px-4 py-2 rounded-full text-xs font-semibold uppercase tracking-wider mb-6">
                        <i class="fas fa-heart-pulse"></i> <span id="docType">Folheto Informativo</span>
                    </span>
                    <p class="text-xs uppercase tracking-widest text-slate-400 mb-2" id="docSubtitle">Informação para o
                        utilizador</p>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-2" id="docTitle">-</h1>
                    <p class="text-xl text-blue-600 font-medium mb-8" id="docSubstance"></p>
                    <div class="w-16 h-1 bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full mx-auto mb-8"></div>
                </div>

                <!-- Info Alert (optional, shown if intro section exists) -->
                <div id="introAlert"
                    class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-xl p-6 text-left">
                    <div class="flex items-center gap-3 mb-4">
                        <i class="fas fa-circle-info text-2xl text-blue-500"></i>
                        <h3 class="font-semibold text-blue-900">Leia com atenção antes de tomar este medicamento</h3>
                    </div>
                    <div id="introContent" class="text-slate-600 rendered-content"></div>
                </div>
            </div>

            <!-- Sections Container -->
            <div id="sectionsContainer" class="space-y-4">
                <!-- Sections rendered dynamically -->
            </div>

            <!-- Metadata Card -->
            <div id="metadataCard" class="hidden mt-8 bg-white rounded-2xl shadow-md border border-slate-100 p-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-info-circle text-blue-500"></i> Metadados do Documento
                </h3>
                <div id="metadataContent" class="grid md:grid-cols-2 gap-4 text-sm"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-slate-400 py-6 mt-12">
        <div class="max-w-4xl mx-auto px-4 text-center text-sm">
            <p>FHIR ePI Viewer — Visualizador de Folhetos Informativos HL7 FHIR</p>
            <p class="mt-2">Desenvolvido para demonstração de interoperabilidade de dados de medicamentos</p>
        </div>
    </footer>

    <script>
        // Section icons mapping based on common section numbers/titles
        const sectionIcons = {
            '1': { icon: 'fa-capsules', bgColor: 'bg-blue-50', textColor: 'text-blue-600' },
            '2': { icon: 'fa-triangle-exclamation', bgColor: 'bg-amber-50', textColor: 'text-amber-600' },
            '3': { icon: 'fa-pills', bgColor: 'bg-blue-50', textColor: 'text-blue-600' },
            '4': { icon: 'fa-heart-pulse', bgColor: 'bg-rose-50', textColor: 'text-rose-600' },
            '5': { icon: 'fa-temperature-low', bgColor: 'bg-cyan-50', textColor: 'text-cyan-600' },
            '6': { icon: 'fa-box', bgColor: 'bg-purple-50', textColor: 'text-purple-600' },
            'default': { icon: 'fa-file-medical', bgColor: 'bg-slate-50', textColor: 'text-slate-600' }
        };

        // Icon keywords mapping
        const iconKeywords = {
            'composição': 'fa-flask',
            'composition': 'fa-flask',
            'efeitos': 'fa-heart-pulse',
            'effects': 'fa-heart-pulse',
            'secundários': 'fa-heart-pulse',
            'side': 'fa-heart-pulse',
            'conservar': 'fa-temperature-low',
            'store': 'fa-temperature-low',
            'storage': 'fa-temperature-low',
            'tomar': 'fa-pills',
            'take': 'fa-pills',
            'dose': 'fa-pills',
            'dosage': 'fa-pills',
            'precauções': 'fa-triangle-exclamation',
            'precautions': 'fa-triangle-exclamation',
            'warnings': 'fa-triangle-exclamation',
            'advertências': 'fa-triangle-exclamation',
            'conteúdo': 'fa-box',
            'contents': 'fa-box',
            'package': 'fa-box',
            'embalagem': 'fa-box',
            'gravidez': 'fa-baby',
            'pregnancy': 'fa-baby',
            'crianças': 'fa-child',
            'children': 'fa-child',
            'pediatric': 'fa-child',
            'condução': 'fa-car',
            'driving': 'fa-car',
            'interações': 'fa-pills',
            'interactions': 'fa-pills'
        };

        // Current loaded bundle data
        let currentBundle = null;

        // Drag and drop handlers
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        // File selection handler
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Process uploaded file
        function processFile(file) {
            if (!file.name.endsWith('.json')) {
                showError('Por favor, selecione um ficheiro JSON válido.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    renderFhirBundle(data);
                } catch (err) {
                    showError('Erro ao processar o ficheiro JSON: ' + err.message);
                }
            };
            reader.onerror = () => {
                showError('Erro ao ler o ficheiro.');
            };
            reader.readAsText(file);
        }

        // Load from URL
        async function loadFromUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                showError('Por favor, introduza um URL válido.');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderFhirBundle(data);
            } catch (err) {
                showError('Erro ao carregar o ficheiro: ' + err.message);
                showLoading(false);
            }
        }

        // Load sample file
        async function loadSampleFile() {
            showLoading(true);
            try {
                const response = await fetch('Bundle-bundlepackageleaflet-pt-49178f16170ee8a6bc2a4361c1748d5f.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderFhirBundle(data);
            } catch (err) {
                showError('Erro ao carregar o ficheiro de exemplo: ' + err.message);
                showLoading(false);
            }
        }

        // Show/hide upload section
        function showUploadSection() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('documentContent').classList.add('hidden');
            document.getElementById('newDocBtn').classList.add('hidden');
            document.getElementById('newDocBtn').classList.remove('inline-flex');
        }

        // Show loading indicator
        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            document.getElementById('uploadSection').classList.toggle('hidden', show);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // Get icon for section based on title
        function getIconForSection(title, index) {
            const lowerTitle = title.toLowerCase();

            // Check for keyword matches
            for (const [keyword, icon] of Object.entries(iconKeywords)) {
                if (lowerTitle.includes(keyword)) {
                    return icon;
                }
            }

            // Check for section number
            const match = title.match(/^(\d+)\./);
            if (match && sectionIcons[match[1]]) {
                return sectionIcons[match[1]].icon;
            }

            // Default icon based on index
            const defaultIcons = ['fa-capsules', 'fa-triangle-exclamation', 'fa-pills', 'fa-heart-pulse', 'fa-temperature-low', 'fa-box', 'fa-file-medical'];
            return defaultIcons[index % defaultIcons.length];
        }

        // Get colors for section
        function getColorsForSection(index) {
            const colors = [
                { bg: 'bg-blue-50', text: 'text-blue-600' },
                { bg: 'bg-amber-50', text: 'text-amber-600' },
                { bg: 'bg-blue-50', text: 'text-blue-600' },
                { bg: 'bg-rose-50', text: 'text-rose-600' },
                { bg: 'bg-cyan-50', text: 'text-cyan-600' },
                { bg: 'bg-purple-50', text: 'text-purple-600' },
                { bg: 'bg-emerald-50', text: 'text-emerald-600' },
                { bg: 'bg-indigo-50', text: 'text-indigo-600' }
            ];
            return colors[index % colors.length];
        }

        // Parse XHTML content from FHIR div
        function parseXhtmlContent(div) {
            if (!div) return '';

            // Remove the xmlns attribute and clean up
            let html = div.replace(/xmlns="[^"]*"/g, '');

            // The div is already HTML, just clean it up
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Apply smart formatting to the content
            return applySmartFormatting(tempDiv.innerHTML);
        }

        // Apply smart formatting to detect and style special content
        function applySmartFormatting(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Process paragraphs with bold text that might be subsection headers
            const paragraphs = tempDiv.querySelectorAll('p');
            paragraphs.forEach(p => {
                const text = p.textContent.toLowerCase();
                const strongEl = p.querySelector('strong');

                if (strongEl) {
                    const strongText = strongEl.textContent.toLowerCase();

                    // Warning/Contraindication boxes
                    if (strongText.includes('não tome') || strongText.includes('do not take') ||
                        strongText.includes('não use') || strongText.includes('não utilize')) {
                        wrapInWarningBox(p, 'fa-ban', strongEl.textContent);
                    }
                    // Allergy/Emergency warnings
                    else if (strongText.includes('pare de tomar') || strongText.includes('stop taking') ||
                        strongText.includes('contacte o médico imediatamente') ||
                        strongText.includes('contact your doctor immediately')) {
                        wrapInWarningBox(p, 'fa-exclamation-triangle', strongEl.textContent);
                    }
                    // Overdose warning
                    else if (strongText.includes('tomar mais') || strongText.includes('take more') ||
                        strongText.includes('sobredosagem') || strongText.includes('overdose')) {
                        wrapInWarningBox(p, 'fa-exclamation-circle', strongEl.textContent);
                    }
                    // Missed dose info
                    else if (strongText.includes('esqueceu') || strongText.includes('forgot') ||
                        strongText.includes('missed')) {
                        wrapInInfoBox(p, 'fa-clock', strongEl.textContent, 'amber');
                    }
                    // Dosage info - specific patient groups
                    else if (strongText.includes('doentes com pressão') && strongText.includes('diabetes')) {
                        wrapInDosageBox(p, 'fa-user-plus', strongEl.textContent, 'purple');
                    }
                    else if (strongText.includes('doentes com') || strongText.includes('patients with')) {
                        wrapInDosageBox(p, 'fa-user', strongEl.textContent);
                    }
                    // General dose info
                    else if (strongText.includes('dose')) {
                        wrapInDosageBox(p, 'fa-prescription-bottle', strongEl.textContent);
                    }
                    // Mode of administration
                    else if (strongText.includes('modo de administração') || strongText.includes('how to take') ||
                        strongText.includes('via oral')) {
                        wrapInSubsectionLabel(p, strongEl.textContent);
                    }
                    // Pregnancy
                    else if (strongText.includes('gravidez') || strongText.includes('pregnancy')) {
                        wrapInInfoBox(p, 'fa-person-pregnant', strongEl.textContent, 'pink');
                    }
                    // Breastfeeding
                    else if (strongText.includes('amamentação') || strongText.includes('breastfeeding')) {
                        wrapInInfoBox(p, 'fa-baby', strongEl.textContent, 'pink');
                    }
                    // Driving
                    else if (strongText.includes('condução') || strongText.includes('driving') ||
                        strongText.includes('máquinas') || strongText.includes('machines')) {
                        wrapInInfoBox(p, 'fa-car', strongEl.textContent, 'amber');
                    }
                    // Children / Utilização em crianças
                    else if (strongText.includes('crianças') || strongText.includes('children') ||
                        strongText.includes('adolescentes') || strongText.includes('pediatric') ||
                        strongText.includes('utilização em')) {
                        wrapInInfoBox(p, 'fa-child', strongEl.textContent, 'cyan');
                    }
                    // Interactions
                    else if (strongText.includes('outros medicamentos') || strongText.includes('other medicines') ||
                        strongText.includes('interações') || strongText.includes('interactions')) {
                        wrapInSubsectionLabel(p, strongEl.textContent);
                    }
                    // Blood tests needed
                    else if (strongText.includes('verificações ao sangue') || strongText.includes('blood tests') ||
                        strongText.includes('análises')) {
                        wrapInInfoBox(p, 'fa-vial', strongEl.textContent, 'purple');
                    }
                    // Side effects reporting
                    else if (strongText.includes('comunicação de efeitos') || strongText.includes('reporting side effects')) {
                        wrapInInfoBox(p, 'fa-comment-medical', strongEl.textContent, 'emerald');
                    }
                    // Food and drink
                    else if (strongText.includes('alimentos') || strongText.includes('bebidas') ||
                        strongText.includes('food') || strongText.includes('drink')) {
                        wrapInInfoBox(p, 'fa-utensils', strongEl.textContent, 'emerald');
                    }
                    // Composition / Contains
                    else if (strongText.includes('composição') || strongText.includes('composition')) {
                        wrapInSubsectionLabel(p, strongEl.textContent);
                    }
                    // Contains lactose/sodium warnings
                    else if (strongText.includes('contém lactose') || strongText.includes('contains lactose') ||
                        strongText.includes('contém sódio') || strongText.includes('contains sodium')) {
                        wrapInInfoBox(p, 'fa-info-circle', strongEl.textContent, 'amber');
                    }
                    // Warnings and precautions
                    else if (strongText.includes('advertências') || strongText.includes('warnings') ||
                        strongText.includes('precauções') || strongText.includes('precautions')) {
                        wrapInSubsectionLabel(p, strongEl.textContent);
                    }
                    // Appearance / Package
                    else if (strongText.includes('aspeto') || strongText.includes('aspecto') ||
                        strongText.includes('appearance') || strongText.includes('embalagem')) {
                        wrapInSubsectionLabel(p, strongEl.textContent);
                    }
                    // Marketing Authorization Holder / Manufacturer
                    else if (strongText.includes('titular') || strongText.includes('fabricante') ||
                        strongText.includes('holder') || strongText.includes('manufacturer')) {
                        wrapInSubsectionLabel(p, strongEl.textContent);
                    }
                }
            });

            // Look for list items that describe patient groups for dosage
            const listItems = tempDiv.querySelectorAll('ul > li');
            listItems.forEach(li => {
                const text = li.textContent.toLowerCase();
                // Check if this is a dosage indication for specific patients
                if ((text.includes('doentes com') || text.includes('patients with')) &&
                    (text.includes('dose') || text.includes('mg') || text.includes('pressão'))) {
                    const isComplex = text.includes('diabetes') || text.includes('renal') || text.includes('rins');
                    const bgColor = isComplex ? 'bg-purple-50 border-purple-200' : 'bg-blue-50 border-blue-200';
                    const titleColor = isComplex ? 'text-purple-800' : 'text-blue-800';
                    const textColor = isComplex ? 'text-purple-700' : 'text-blue-700';
                    const icon = isComplex ? 'fa-user-plus' : 'fa-user';

                    li.outerHTML = `
                        <div class="${bgColor} border rounded-xl p-4 my-3">
                            <p class="font-semibold ${titleColor} mb-1"><i class="fas ${icon} mr-2"></i>${li.innerHTML}</p>
                        </div>
                    `;
                }
            });

            // Detect and style side effects frequency content
            const fullText = tempDiv.textContent.toLowerCase();
            if (fullText.includes('muito frequentes') || fullText.includes('very common') ||
                fullText.includes('frequentes') || fullText.includes('common') ||
                fullText.includes('pouco frequentes') || fullText.includes('uncommon')) {

                // Style frequency items in lists
                const listItems = tempDiv.querySelectorAll('li');
                listItems.forEach(li => {
                    const liText = li.textContent.toLowerCase();

                    if (liText.startsWith('muito frequentes') || liText.startsWith('very common')) {
                        styleFrequencyItem(li, 'very-common', 'Muito frequentes');
                    } else if (liText.startsWith('frequentes') || liText.startsWith('common')) {
                        styleFrequencyItem(li, 'common', 'Frequentes');
                    } else if (liText.startsWith('pouco frequentes') || liText.startsWith('uncommon')) {
                        styleFrequencyItem(li, 'uncommon', 'Pouco frequentes');
                    } else if (liText.startsWith('raros') || liText.startsWith('rare')) {
                        styleFrequencyItem(li, 'rare', 'Raros');
                    }
                });

                // Also check for frequency legend paragraphs
                paragraphs.forEach(p => {
                    const pText = p.textContent.toLowerCase();
                    if (pText.includes('muito frequentes') && pText.includes('podem afetar')) {
                        styleFrequencyLegendItem(p, 'very-common');
                    } else if (pText.includes('frequentes') && pText.includes('podem afetar') && !pText.includes('muito') && !pText.includes('pouco')) {
                        styleFrequencyLegendItem(p, 'common');
                    } else if (pText.includes('pouco frequentes') && pText.includes('podem afetar')) {
                        styleFrequencyLegendItem(p, 'uncommon');
                    } else if (pText.includes('raros') && pText.includes('podem afetar')) {
                        styleFrequencyLegendItem(p, 'rare');
                    }
                });
            }

            // Detect storage instructions
            if (fullText.includes('conservar') || fullText.includes('store') ||
                fullText.includes('validade') || fullText.includes('expiry')) {
                formatStorageSection(tempDiv);
            }

            return tempDiv.innerHTML;
        }

        // Helper function to wrap element in warning box
        function wrapInWarningBox(el, icon, title) {
            const content = el.innerHTML.replace(/<strong[^>]*>.*?<\/strong>/i, '').trim();
            el.outerHTML = `
                <div class="warning-box">
                    <div class="warning-box-title">
                        <i class="fas ${icon}"></i> ${title}
                    </div>
                    <div class="warning-box-content">${content}</div>
                </div>
            `;
        }

        // Helper function to wrap element in dosage box
        function wrapInDosageBox(el, icon, title, variant = '') {
            const content = el.innerHTML.replace(/<strong[^>]*>.*?<\/strong>/i, '').trim();
            // Determine if it should be purple (for special patient groups)
            const titleLower = title.toLowerCase();
            let variantClass = variant;
            if (titleLower.includes('diabetes') || titleLower.includes('renal') ||
                titleLower.includes('rins') || titleLower.includes('kidney')) {
                variantClass = 'purple';
                icon = 'fa-user-plus';
            }
            el.outerHTML = `
                <div class="dosage-box ${variantClass}">
                    <div class="dosage-box-title">
                        <i class="fas ${icon}"></i> ${title}
                    </div>
                    <div class="dosage-box-content">${content}</div>
                </div>
            `;
        }

        // Helper function to wrap element in info box
        function wrapInInfoBox(el, icon, title, color = 'blue') {
            const content = el.innerHTML.replace(/<strong[^>]*>.*?<\/strong>/i, '').trim();
            const colorClasses = {
                blue: { bg: 'bg-blue-50', border: 'border-blue-200', title: 'text-blue-800', content: 'text-blue-700' },
                purple: { bg: 'bg-purple-50', border: 'border-purple-200', title: 'text-purple-800', content: 'text-purple-700' },
                emerald: { bg: 'bg-emerald-50', border: 'border-emerald-200', title: 'text-emerald-800', content: 'text-emerald-700' },
                amber: { bg: 'bg-amber-50', border: 'border-amber-200', title: 'text-amber-800', content: 'text-amber-700' },
                cyan: { bg: 'bg-cyan-50', border: 'border-cyan-200', title: 'text-cyan-800', content: 'text-cyan-700' },
                pink: { bg: 'bg-pink-50', border: 'border-pink-200', title: 'text-pink-800', content: 'text-pink-700' }
            };
            const c = colorClasses[color] || colorClasses.blue;

            el.outerHTML = `
                <div class="${c.bg} border ${c.border} rounded-xl p-4 my-4">
                    <p class="font-semibold ${c.title} mb-2"><i class="fas ${icon} mr-2"></i>${title}</p>
                    <p class="${c.content}">${content}</p>
                </div>
            `;
        }

        // Helper to add subsection label styling
        function wrapInSubsectionLabel(el, title) {
            const content = el.innerHTML.replace(/<strong[^>]*>.*?<\/strong>/i, '').trim();
            el.outerHTML = `
                <p><span class="subsection-label">${title}</span></p>
                ${content ? `<p>${content}</p>` : ''}
            `;
        }

        // Style frequency item in list
        function styleFrequencyItem(li, frequencyClass, label) {
            const text = li.innerHTML;
            // Extract content after the frequency label
            const labelPatterns = [
                /muito frequentes[^:]*:/i,
                /very common[^:]*:/i,
                /frequentes[^:]*:/i,
                /common[^:]*:/i,
                /pouco frequentes[^:]*:/i,
                /uncommon[^:]*:/i,
                /raros[^:]*:/i,
                /rare[^:]*:/i
            ];

            let content = text;
            for (const pattern of labelPatterns) {
                content = content.replace(pattern, '');
            }

            li.outerHTML = `
                <div class="frequency-item ${frequencyClass}">
                    <span class="frequency-dot ${frequencyClass}"></span>
                    <div>
                        <strong class="frequency-label ${frequencyClass}">${label}:</strong>
                        ${content.trim()}
                    </div>
                </div>
            `;
        }

        // Style frequency legend paragraph
        function styleFrequencyLegendItem(p, frequencyClass) {
            const colorMap = {
                'very-common': { bg: 'from-red-100 to-red-50', dot: 'bg-red-500', text: 'text-red-700' },
                'common': { bg: 'from-orange-100 to-orange-50', dot: 'bg-orange-500', text: 'text-orange-700' },
                'uncommon': { bg: 'from-yellow-100 to-yellow-50', dot: 'bg-yellow-500', text: 'text-yellow-700' },
                'rare': { bg: 'from-blue-100 to-blue-50', dot: 'bg-blue-500', text: 'text-blue-700' }
            };
            const c = colorMap[frequencyClass];

            p.outerHTML = `
                <div class="flex items-center gap-3 bg-gradient-to-r ${c.bg} rounded-xl p-3 my-2">
                    <div class="w-3 h-3 ${c.dot} rounded-full"></div>
                    <span class="${c.text}">${p.innerHTML}</span>
                </div>
            `;
        }

        // Format storage section with grid layout
        function formatStorageSection(container) {
            const paragraphs = container.querySelectorAll('p');
            const storageItems = [];

            paragraphs.forEach(p => {
                const text = p.textContent.toLowerCase();

                if (text.includes('crianças') || text.includes('children') || text.includes('alcance')) {
                    storageItems.push({
                        icon: 'fa-child',
                        title: 'Crianças',
                        content: p.textContent,
                        bgColor: 'bg-cyan-50',
                        borderColor: 'border-cyan-200',
                        iconBg: 'bg-cyan-100',
                        iconColor: 'text-cyan-600',
                        titleColor: 'text-cyan-800',
                        textColor: 'text-cyan-700'
                    });
                    p.remove();
                }
                else if (text.includes('validade') || text.includes('expiry') || text.includes('após val')) {
                    storageItems.push({
                        icon: 'fa-calendar-xmark',
                        title: 'Validade',
                        content: p.textContent,
                        bgColor: 'bg-amber-50',
                        borderColor: 'border-amber-200',
                        iconBg: 'bg-amber-100',
                        iconColor: 'text-amber-600',
                        titleColor: 'text-amber-800',
                        textColor: 'text-amber-700'
                    });
                    p.remove();
                }
                else if (text.includes('temperatura') || text.includes('temperature') ||
                    text.includes('30°c') || text.includes('30ºc') || text.includes('acima de')) {
                    storageItems.push({
                        icon: 'fa-temperature-high',
                        title: 'Temperatura',
                        content: p.textContent,
                        bgColor: 'bg-red-50',
                        borderColor: 'border-red-200',
                        iconBg: 'bg-red-100',
                        iconColor: 'text-red-600',
                        titleColor: 'text-red-800',
                        textColor: 'text-red-700'
                    });
                    p.remove();
                }
                else if (text.includes('ambiente') || text.includes('deite fora') ||
                    text.includes('lixo') || text.includes('canalização') || text.includes('disposal')) {
                    storageItems.push({
                        icon: 'fa-leaf',
                        title: 'Ambiente',
                        content: p.textContent,
                        bgColor: 'bg-emerald-50',
                        borderColor: 'border-emerald-200',
                        iconBg: 'bg-emerald-100',
                        iconColor: 'text-emerald-600',
                        titleColor: 'text-emerald-800',
                        textColor: 'text-emerald-700'
                    });
                    p.remove();
                }
            });

            if (storageItems.length > 0) {
                let gridHtml = '<div class="storage-grid">';
                storageItems.forEach(item => {
                    gridHtml += `
                        <div class="storage-item ${item.bgColor} border ${item.borderColor}">
                            <div class="storage-icon ${item.iconBg}">
                                <i class="fas ${item.icon} ${item.iconColor}"></i>
                            </div>
                            <div>
                                <p class="font-semibold ${item.titleColor}">${item.title}</p>
                                <p class="${item.textColor} text-sm">${item.content}</p>
                            </div>
                        </div>
                    `;
                });
                gridHtml += '</div>';

                // Insert grid at the beginning
                container.insertAdjacentHTML('afterbegin', gridHtml);
            }
        }        // Render nested sections recursively
        function renderNestedSections(sections, depth = 0) {
            if (!sections || sections.length === 0) return '';

            let html = '';

            sections.forEach((section, index) => {
                const title = section.title || '';
                const textDiv = section.text?.div || '';
                const content = parseXhtmlContent(textDiv);
                const nestedSections = section.section || [];

                if (depth === 0) {
                    // Skip intro/TOC sections at top level
                    const lowerTitle = title.toLowerCase();
                    if (lowerTitle.includes('informação para o utilizador') ||
                        lowerTitle.includes('o que contém este folheto') ||
                        lowerTitle.includes('what is in this leaflet') ||
                        title === 'B. FOLHETO INFORMATIVO' ||
                        title === 'B. PACKAGE LEAFLET') {
                        // Process nested sections if this is just a container
                        if (nestedSections.length > 0) {
                            html += renderNestedSections(nestedSections, depth);
                        }
                        return;
                    }
                }

                if (depth === 0) {
                    // Main section
                    const icon = getIconForSection(title, index);
                    const colors = getColorsForSection(index);
                    const sectionNumber = title.match(/^(\d+)\./) ? title.match(/^(\d+)\./)[1] : (index + 1);
                    const cleanTitle = title.replace(/^\d+\.\s*/, '');

                    html += `
                        <div class="section bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden hover:shadow-lg transition-all hover:-translate-y-0.5">
                            <div class="section-header flex items-center justify-between p-5 cursor-pointer hover:bg-slate-50 transition-colors" onclick="toggleSection(this)">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 ${colors.bg} ${colors.text} rounded-xl flex items-center justify-center text-xl">
                                        <i class="fas ${icon}"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400 font-medium mb-1">Secção ${sectionNumber}</p>
                                        <h2 class="text-base font-semibold text-slate-800">${cleanTitle}</h2>
                                    </div>
                                </div>
                                <div class="toggle-icon w-9 h-9 bg-slate-100 rounded-full flex items-center justify-center text-slate-400">
                                    <i class="fas fa-chevron-down text-sm"></i>
                                </div>
                            </div>
                            <div class="section-content">
                                <div class="px-5 pb-5 pt-4 border-t border-slate-100 ml-16 space-y-4 text-slate-600 leading-relaxed rendered-content">
                                    ${content}
                                    ${renderNestedSections(nestedSections, depth + 1)}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Nested section
                    if (title || content) {
                        html += `
                            <div class="nested-section">
                                ${title ? `<span class="nested-section-title">${title}</span>` : ''}
                                <div class="rendered-content mt-2">
                                    ${content}
                                    ${renderNestedSections(nestedSections, depth + 1)}
                                </div>
                            </div>
                        `;
                    }
                }
            });

            return html;
        }

        // Extract metadata from bundle
        function extractMetadata(bundle) {
            const metadata = {
                bundleId: bundle.id || '-',
                timestamp: bundle.timestamp ? new Date(bundle.timestamp).toLocaleString('pt-PT') : '-',
                language: bundle.language || '-',
                identifier: bundle.identifier?.value || '-'
            };

            // Find Organization (MAH)
            const orgEntry = bundle.entry?.find(e => e.resource?.resourceType === 'Organization');
            if (orgEntry?.resource?.name) {
                metadata.organization = orgEntry.resource.name;
            }

            // Find MedicinalProductDefinition
            const mpEntry = bundle.entry?.find(e => e.resource?.resourceType === 'MedicinalProductDefinition');
            if (mpEntry?.resource?.name?.[0]?.productName) {
                metadata.productName = mpEntry.resource.name[0].productName;
            }

            return metadata;
        }

        // Extract document info from Composition
        function extractDocumentInfo(composition) {
            const info = {
                title: '',
                subtitle: '',
                substance: '',
                type: 'Folheto Informativo'
            };

            // Get title from composition
            if (composition.title) {
                info.title = composition.title.replace(/TEST PURPOSES ONLY - /i, '');
            }

            // Try to extract medicine name and substance from intro section
            const introSection = findIntroSection(composition.section);
            if (introSection?.text?.div) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = introSection.text.div;

                const paragraphs = tempDiv.querySelectorAll('p');
                if (paragraphs.length >= 2) {
                    const firstP = paragraphs[0].textContent.trim();
                    const secondP = paragraphs[1].textContent.trim();

                    // Check if it looks like a medicine name
                    if (firstP && firstP.length < 100) {
                        info.title = firstP;
                    }
                    if (secondP && secondP.length < 50 && !secondP.includes(' ')) {
                        info.substance = secondP;
                    }
                }
            }

            // Get type from category
            if (composition.category?.[0]?.coding?.[0]?.display) {
                info.type = composition.category[0].coding[0].display;
            }

            return info;
        }

        // Find intro section
        function findIntroSection(sections) {
            if (!sections) return null;

            for (const section of sections) {
                const title = (section.title || '').toLowerCase();
                if (title.includes('informação para o utilizador') ||
                    title.includes('information for the user') ||
                    title.includes('folheto informativo')) {
                    return section;
                }

                // Check nested
                if (section.section) {
                    const found = findIntroSection(section.section);
                    if (found) return found;
                }
            }

            return null;
        }

        // Get intro content (bullet points)
        function getIntroContent(sections) {
            const introSection = findIntroSection(sections);
            if (!introSection?.text?.div) return null;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = introSection.text.div;

            const ul = tempDiv.querySelector('ul');
            if (ul) {
                return ul.outerHTML;
            }

            return null;
        }

        // Main render function
        function renderFhirBundle(bundle) {
            showLoading(false);
            currentBundle = bundle;

            // Validate bundle
            if (bundle.resourceType !== 'Bundle') {
                showError('O ficheiro não é um FHIR Bundle válido.');
                return;
            }

            // Find Composition resource
            const compositionEntry = bundle.entry?.find(e => e.resource?.resourceType === 'Composition');
            if (!compositionEntry) {
                showError('Não foi encontrado um recurso Composition no Bundle.');
                return;
            }

            const composition = compositionEntry.resource;

            // Extract document info
            const docInfo = extractDocumentInfo(composition);
            document.getElementById('docTitle').textContent = docInfo.title || composition.title || 'Documento FHIR';
            document.getElementById('docSubstance').textContent = docInfo.substance;
            document.getElementById('docType').textContent = docInfo.type;

            // Render intro section if available
            const introContent = getIntroContent(composition.section);
            const introAlert = document.getElementById('introAlert');
            if (introContent) {
                document.getElementById('introContent').innerHTML = introContent;
                introAlert.classList.remove('hidden');
            } else {
                introAlert.classList.add('hidden');
            }

            // Render main sections
            const sectionsHtml = renderNestedSections(composition.section);
            document.getElementById('sectionsContainer').innerHTML = sectionsHtml;

            // Render metadata
            const metadata = extractMetadata(bundle);
            let metadataHtml = '';
            const metadataLabels = {
                bundleId: 'ID do Bundle',
                timestamp: 'Data/Hora',
                language: 'Idioma',
                identifier: 'Identificador',
                organization: 'Organização',
                productName: 'Nome do Produto'
            };

            for (const [key, value] of Object.entries(metadata)) {
                if (value && value !== '-') {
                    metadataHtml += `
                        <div class="flex flex-col">
                            <span class="text-slate-400 text-xs uppercase tracking-wider">${metadataLabels[key] || key}</span>
                            <span class="text-slate-700 font-medium">${value}</span>
                        </div>
                    `;
                }
            }

            if (metadataHtml) {
                document.getElementById('metadataContent').innerHTML = metadataHtml;
                document.getElementById('metadataCard').classList.remove('hidden');
            }

            // Show document content, hide upload section
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('documentContent').classList.remove('hidden');
            document.getElementById('newDocBtn').classList.remove('hidden');
            document.getElementById('newDocBtn').classList.add('inline-flex');
        }

        // Toggle section expansion
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('active');
        }

        // Check for URL parameter to auto-load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const fileUrl = urlParams.get('url');
            const file = urlParams.get('file');

            if (fileUrl) {
                document.getElementById('urlInput').value = fileUrl;
                loadFromUrl();
            } else if (file) {
                document.getElementById('urlInput').value = file;
                loadFromUrl();
            }
        });
    </script>
</body>

</html>